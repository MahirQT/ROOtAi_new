<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ROOTAI â€“ Probe Scanner</title>

    <script src="https://cdn.tailwindcss.com"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    

    <style>
        /* Mobile container style matching your main app */
        .mobile-container {
            max-width: 375px;
            margin: 0 auto;
            min-height: 100vh;
            background: #f8fafc; /* light background matching your screenshot */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        /* Header bar style to match main app's feature/navigation headers */
        .header-bar {
            background: #ef8b03; /* Used a deep orange/brown for distinct feature header */
            color: white;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            /* Negative margin moves the header to the edge of the mobile view */
            margin: -20px -20px 20px -20px; 
        }

        /* Styling for the back button (using an SVG placeholder for now) */
        .back-btn {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        /* Custom style for the QR Reader box border */
        #reader {
            border: 2px solid #a855f7; /* Purple border to match the QR button color */
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="mobile-container p-5">
        
        <div class="header-bar">
           <svg class="back-btn" fill="currentColor" viewBox="0 0 20 20" onclick="window.location.href='/'">
    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
</svg>
            <h2 class="text-lg font-semibold">Probe QR Scanner</h2>
        </div>

        <div class="flex flex-col items-center justify-center text-center">
            
            <h1 class="text-xl font-bold text-gray-800 mb-4">Start Field Scan</h1>
            
            <div id="reader" class="w-full max-w-sm h-64 rounded-xl overflow-hidden mb-4"></div>
            
            <div id="status" class="w-full max-w-sm p-3 bg-gray-100 text-gray-700 rounded-lg font-medium shadow-sm">
                Initializing cameraâ€¦
            </div>
            
            <button id="retryBtn" class="w-full max-w-sm py-3 rounded-lg bg-purple-600 text-white font-semibold mt-6 shadow-md" style="display:none;">
                Scan Next Probe
            </button>
        </div>

    </div>

    <script>
    // --- IMPORTANT: This uses the Namespaced (Compat) SDK method ---
    
    // Global variables passed from Flask (assuming they are defined in a prior script block)
    const USER_UID = "{{ user_uid }}";
    const FIELD_ID = "{{ field_id }}"; 

    /* ---------------- FIREBASE SETUP ---------------- */
    // Initialize the app (This must be done via a standard script block)
    const firebaseConfig = {
        apiKey: "AIzaSyAMF-H37hakWbtwGfy8-wvTWV_5RtYoUmY",
        authDomain: "esp32---demo-ac37f.firebaseapp.com",
        databaseURL: "https://esp32---demo-ac37f-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "esp32---demo-ac37f",
        appId: "1:465358325818:web:11322d74bef27fc9d38d03",
    };
    const app = firebase.initializeApp(firebaseConfig);
    // Access Firestore using the global 'firebase' object
    const db = firebase.firestore(); 
    
    /* ---------------- GLOBAL SCANNER VARIABLES ---------------- */
    let offlineQueue = JSON.parse(localStorage.getItem("offlineQueue")) || [];
    // CRITICAL: Html5Qrcode must be instantiated here
    const html5QrCode = new Html5Qrcode("reader"); 
    const qrConfig = { fps: 10, qrbox: { width: 250, height: 250 }, facingMode: "environment" };


    /* ---------------- OFFLINE/SYNC HELPERS ---------------- */
    function saveOffline(data) {
        offlineQueue.push(data);
        localStorage.setItem("offlineQueue", JSON.stringify(offlineQueue));
    }
    // (syncOffline function would be placed here)

    /* ---------------- QR SCANNER FUNCTIONS ---------------- */
    async function startScanner() {
        document.getElementById('status').innerText = "Scanning for QRâ€¦";
        document.getElementById('retryBtn').style.display = "none";
        
        try {
            if (html5QrCode.isScanning) await html5QrCode.stop(); 
        } catch (e) {}

        html5QrCode.start(
            { facingMode: "environment" },
            qrConfig,
            async (qrText) => {
                // SUCCESS: Stop the camera immediately after decoding
                await html5QrCode.stop(); 
                handleQRScan(qrText); // Go to saving logic
            }, 
            (errorMessage) => {}
        ).catch(err => {
            document.getElementById('status').innerText = `Error: Cannot start camera. (${err.name || err})`;
            document.getElementById('retryBtn').innerText = "Retry Scan";
            document.getElementById('retryBtn').style.display = "block";
        });
    }

    // qr_scanner.html

async function handleQRScan(probeId) {
    document.getElementById('status').innerText = `Probe ID ${probeId}: Fetching GPS locationâ€¦`;

    if (!navigator.geolocation) {
        document.getElementById('status').innerText = "Geolocation not supported!";
        return;
    }

    navigator.geolocation.getCurrentPosition(async (pos) => {
        const latitude = pos.coords.latitude;
        const longitude = pos.coords.longitude;
        
        // 1. Prepare data payload
        const dataToSave = {
            field_id: FIELD_ID, 
            probe_id: probeId,
            latitude: latitude.toFixed(6),
            longitude: longitude.toFixed(6),
            // CRITICAL FIX: Use the authenticated UID variable passed from Flask
            user_id: USER_UID, 
            // CRITICAL CHANGE: Use GeoPoint for location data
            location: new firebase.firestore.GeoPoint(latitude, longitude),
            // CRITICAL: namespaced API for serverTimestamp 
            timestamp: firebase.firestore.FieldValue.serverTimestamp(), 
            status: "active"
        };

        try {
            if (navigator.onLine) {
                // CRITICAL: Write to the top-level 'scans' collection
                await db
                    .collection("scans")
                    .add(dataToSave);
                    
                // --- SUCCESS MESSAGE & FLAG SETTING ---
                document.getElementById('status').innerHTML = `
                    <div class="text-green-600 font-semibold mb-2">âœ… Probe planted successfully!</div>
                    <p class="font-bold text-green-700 mt-2">Planted Position:</p>
                    <p class="text-sm">Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}</p>
                    <p class="mt-2">Move towards the next probe.</p>
                `;
                
                // Set flag to trigger map visualization reload on the home/live screen
                localStorage.setItem('deployment_success', 'true');
                // --- END SUCCESS MESSAGE & FLAG SETTING ---
                
            } else {
                saveOffline(dataToSave);
                document.getElementById('status').innerText = "ðŸ“¦ Saved offline, will sync later!";
            }
        } catch (e) {
            console.error("Firebase save error:", e);
            document.getElementById('status').innerText = "âš ï¸ Error saving, data saved offline or permission issue!";
        }

        document.getElementById('retryBtn').innerText = "Scan Next Probe";
        document.getElementById('retryBtn').style.display = "block";

    }, () => {
        // Geolocation error handling
        document.getElementById('status').innerText = "Unable to get location! Try again.";
        document.getElementById('retryBtn').innerText = "Retry Scan";
        document.getElementById('retryBtn').style.display = "block";
    }, { enableHighAccuracy: true, timeout: 10000 });
}

    // --- FIX: The "Scan Next Probe" button listener ---
    document.getElementById('retryBtn').addEventListener('click', () => {
        // 1. Hide the success message container
        document.getElementById('status').innerHTML = "Initializing cameraâ€¦";
        
        // 2. Hide the button
        document.getElementById('retryBtn').style.display = "none";
        
        // 3. CRITICAL: Restart the full scanner/camera initialization
        startScanner();
    });

    // Start scanner on initial load
    startScanner();
</script>
</body>
</html>